name: Release develop to main when Dependabot is clear

on:
  pull_request:
    types: [closed]
  schedule:
    - cron: "0 3 * * *"
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  release:
    if: |
      github.event_name != 'pull_request' ||
      (github.event.pull_request.merged == true && github.event.pull_request.user.login == 'dependabot[bot]')
    runs-on: ubuntu-latest
    env:
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    steps:
      - uses: actions/checkout@v4

      - name: Count open Dependabot PRs
        id: dependabot
        run: |
          count=$(gh pr list --state open --author "dependabot[bot]" --json number --jq 'length')
          echo "count=$count" >> "$GITHUB_OUTPUT"

      - name: Check if develop is ahead of main
        id: compare
        if: steps.dependabot.outputs.count == '0'
        run: |
          ahead=$(gh api repos/$GITHUB_REPOSITORY/compare/main...develop --jq '.ahead_by')
          echo "ahead=$ahead" >> "$GITHUB_OUTPUT"

      - name: Verify changes are only package files
        id: package_changes
        if: steps.dependabot.outputs.count == '0' && steps.compare.outputs.ahead != '0'
        run: |
          files_json=$(gh api repos/$GITHUB_REPOSITORY/compare/main...develop --jq '[.files[].filename]')
          file_count=$(echo "$files_json" | jq 'length')
          allowed_only=$(echo "$files_json" | jq -r 'all(.[]; . == "package.json" or . == "package-lock.json")')
          if [[ "$file_count" -gt 0 && "$allowed_only" == "true" ]]; then
            echo "allowed=true" >> "$GITHUB_OUTPUT"
          else
            echo "allowed=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Find or create release PR
        id: release_pr
        if: steps.dependabot.outputs.count == '0' && steps.compare.outputs.ahead != '0' && steps.package_changes.outputs.allowed == 'true'
        run: |
          pr_number=$(gh pr list --state open --base main --head develop --json number --jq '.[0].number')
          if [[ -z "$pr_number" || "$pr_number" == "null" ]]; then
            pr_url=$(gh pr create --base main --head develop \
              --title "Release: develop â†’ main" \
              --body "Automated release PR opened because no Dependabot PRs are pending.")
            pr_number=$(gh pr view "$pr_url" --json number --jq '.number')
          fi
          echo "number=$pr_number" >> "$GITHUB_OUTPUT"

      - name: Enable auto-merge
        if: steps.release_pr.outputs.number != ''
        run: gh pr merge --auto --merge "${{ steps.release_pr.outputs.number }}"